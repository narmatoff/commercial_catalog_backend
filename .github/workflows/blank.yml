name: CI and Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
  # ... предыдущие шаги остаются без изменений ...

  deploy:
    runs-on: ubuntu-latest
    needs: build
    env:
      DATABASE_URL: ${{ secrets.DEPLOY_LH_DB_URL }}

    steps:
      # ... предыдущие шаги до Deploy Docker image to server ...

      - name: Deploy Docker image to server
        run: |
          ssh -t -o StrictHostKeyChecking=no narmatoff@31.128.38.77 << EOF
          set -e
          cd ~/catalog-bot
          
          # Загрузка образа и проверка
          echo "### Loading Docker image ###"
          bunzip2 < catalog_bot_api.tar.bz2 | docker load
          docker images | grep catalog_bot_api || exit 1

          # Управление сетью
          echo "### Managing network ###"
          docker network inspect catalog_bot_network || docker network create catalog_bot_network

          # Обновление контейнера базы данных
          echo "### Updating DB container ###"
          docker stop catalog_bot_db || true
          docker rm catalog_bot_db || true
          docker run -d --restart=always \
            --name catalog_bot_db \
            --network catalog_bot_network \
            -e POSTGRES_USER=catalogbot_user \
            -e POSTGRES_PASSWORD=catalogbot_password \
            -e PGDATA=/var/lib/postgresql/data/pgdata \
            -v ~/docker/postgresql/data:/var/lib/postgresql/data \
            -p 5432:5432 \
            postgres:16.4

          # Обновление контейнера приложения
          echo "### Updating API container ###"
          docker stop catalog_bot_api || true
          docker rm catalog_bot_api || true
          docker run -d --restart=always \
            --name catalog_bot_api \
            --network catalog_bot_network \
            -p 3001:3001 \
            -e DATABASE_URL="$DATABASE_URL" \
            catalog_bot_api

          # Ожидание инициализации контейнера
          echo "### Waiting for container ###"
          for i in {1..10}; do
            container_id=\$(docker ps -q -f name=catalog_bot_api)
            if [ -n "\$container_id" ]; then
              echo "Container started with ID: \$container_id"
              if docker inspect -f '{{.State.Running}}' \$container_id | grep -q true; then
                break
              fi
            fi
            sleep 3
          done

          # Проверка состояния контейнера
          docker ps -a
          docker inspect catalog_bot_api
          echo "### Deployment completed ###"
          EOF